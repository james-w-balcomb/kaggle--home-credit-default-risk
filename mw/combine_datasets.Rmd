---
title: "exploration.Rmd"
author: "mwinkler"
date: "July 10, 2018"
output: html_document
---

### Environment setup:

```{r message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(tidyverse)
library(magrittr)
library(reshape)
library(Information)
library(data.table)
knitr::opts_chunk$set(echo = TRUE)
setwd('/Users/matt.winkler/Documents/repos/kaggle--home-credit-default-risk/mw')
```


### Summary function:

```{r message=FALSE, warning=FALSE, include=FALSE}
fn <- funs(mean, sd, min, max, sum, n_distinct, .args = list(na.rm = TRUE))
```

### Training data:
```{r message=FALSE, warning=FALSE, include=FALSE}
tr <- read_csv('../data/application_train.csv')
```




### Balance data analysis:

```{r message=FALSE, warning=FALSE, include=FALSE}
#require(data.table)
bbalance <- read_csv("../data/bureau_balance.csv")
bbalance.cur <- bbalance[bbalance$MONTHS_BALANCE == -1, ]

# set up results with unique bbalance IDs:
result_bbalance <- data.frame(unique(bbalance$SK_ID_BUREAU))
names(result_bbalance) <- "SK_ID_BUREAU"
# join current balance data:
result_bbalance <- result_bbalance %>% left_join(bbalance.cur[, c(1,3)], by="SK_ID_BUREAU")
names(result_bbalance) <- c("SK_ID_BUREAU", "CURRENT_STATUS")

status.counts <- bbalance %>%
  group_by(SK_ID_BUREAU, STATUS) %>%
  tally()

status.counts <- cast(status.counts, SK_ID_BUREAU ~ STATUS)
status.counts[is.na(status.counts)] <- 0
status.counts$status_n <- rowSums(status.counts[, 2:9])

# status.names <- c("0", "1", "2", "3", "4", "5", "C", "X")
# for (nm in status.names) {
#   nm_norm <- paste(nm, "_norm", sep = "")
#   status.counts[, nm_norm] <- status.counts[, nm] / status.counts$status_n
# }

result_bbalance <- result_bbalance %>%
  left_join(status.counts, by = "SK_ID_BUREAU")

rm(result, status.counts, bbalance, bbalance.cur); gc()
```


```{r message=FALSE, warning=FALSE, include=FALSE}
bureau <- read_csv("../data/bureau.csv")

result_bureau <- bureau %>% 
  left_join(result_bbalance, by = "SK_ID_BUREAU") %>%
  select(-SK_ID_BUREAU) %>%
  mutate_if(is.character, funs(factor(.) %>% as.integer)) #%>%
  #group_by(SK_ID_CURR, CREDIT_ACTIVE, CREDIT_TYPE, CREDIT_CURRENCY) #%>%
#  summarise_all(funs(sum,))

totals <- result_bureau %>%
  group_by(SK_ID_CURR) %>%
  summarize_all(fn)

grouped <- result_bureau %>%
  group_by(SK_ID_CURR, CREDIT_TYPE, CREDIT_ACTIVE) %>%
  summarise_all(sum)

sel <- names(grouped)[!(names(grouped) %in% c("SK_ID_CURR", "CREDIT_CURRENCY", "CREDIT_TYPE", "CREDIT_ACTIVE"))]

grouped <- dcast(setDT(grouped), 
                   CREDIT_TYPE + SK_ID_CURR ~ CREDIT_ACTIVE, 
                   value.var = sel)

sel <- names(grouped)[!(names(grouped) %in% c("SK_ID_CURR", "CREDIT_CURRENCY", "CREDIT_TYPE"))]

grouped <- dcast(setDT(grouped), 
                   SK_ID_CURR ~ CREDIT_TYPE, 
                   value.var = sel)

result_bureau <- totals %>%
  left_join(grouped, by = "SK_ID_CURR")

rm(bureau, result_bbalance, grouped, totals); gc()

tr <- tr %>%
  left_join(result_bureau, by = "SK_ID_CURR")
```

#### Information value from balance data:

```{r message=FALSE, warning=FALSE, include=FALSE}

y <- as.factor(tr$TARGET)
set.seed(1234)
down_tr <- caret::downSample(x = tr,y = y)
y_tr <- as.numeric(down_tr$Class)
y_tr[y_tr == 1] <- 0
y_tr[y_tr == 2] <- 1
down_tr$Class <- y_tr

IV <- create_infotables(data=down_tr, y="Class")
plot_infotables(IV, IV$Summary$Variable[1:20], same_scale=TRUE)

keep <- IV$Summary$Variable[(IV$Summary$IV >= 0.0001)]
tr <- tr[, keep]
```


### Credit card history data:

```{r message=FALSE, warning=FALSE, include=FALSE}
cc_balance <- read_csv("../data/credit_card_balance.csv")

# Collapse extra levels on the contract status:
ind <- !(cc_balance$NAME_CONTRACT_STATUS %in% c("Active", "Completed", "Signed"))
cc_balance[ind, c("NAME_CONTRACT_STATUS")] <- "Other"

# most recent data:
cc_last_month <- cc_balance[cc_balance$MONTHS_BALANCE == -1, ] %>%
  select(-SK_ID_PREV) %>%
  mutate_if(is.character, funs(factor(.) %>% as.integer)) %>% 
  group_by(SK_ID_CURR, NAME_CONTRACT_STATUS) %>% 
  summarise_all(sum)

sel <- names(cc_last_month)[!(names(cc_last_month) %in% c("SK_ID_CURR", "NAME_CONTRACT_STATUS"))]

cc_last_month <- dcast(setDT(cc_last_month), 
                   SK_ID_CURR ~ NAME_CONTRACT_STATUS, 
                   value.var = sel)

# totals:
cc_contract <- cc_balance %>%
  select(-SK_ID_PREV) %>%
  mutate_if(is.character, funs(factor(.) %>% as.integer)) %>% 
  group_by(SK_ID_CURR, NAME_CONTRACT_STATUS) %>% 
  summarise_all(fn)

sel <- names(cc_contract)[!(names(cc_contract) %in% c("SK_ID_CURR", "NAME_CONTRACT_STATUS"))]

cc_contract <- dcast(setDT(cc_contract), 
                   SK_ID_CURR ~ NAME_CONTRACT_STATUS, 
                   value.var = sel)

tr <- tr %>%
  left_join(cc_last_month, by = "SK_ID_CURR") %>%
  left_join(cc_contract, by = "SK_ID_CURR")

rm(cc_balance, cc_contract, cc_last_month); gc()

```

### Test Information gained from cc data:

```{r message=FALSE, warning=FALSE, include=FALSE}

y <- as.factor(tr$TARGET)
set.seed(1234)
down_tr <- caret::downSample(x = tr,y = y)
y_tr <- as.numeric(down_tr$Class)
y_tr[y_tr == 1] <- 0
y_tr[y_tr == 2] <- 1
down_tr$Class <- y_tr

IV <- create_infotables(data=down_tr, y="Class")
plot_infotables(IV, IV$Summary$Variable[1:20], same_scale=TRUE)

keep <- IV$Summary$Variable[(IV$Summary$IV >= 0.0001)]
tr <- tr[, keep]
```



```{r message=FALSE, warning=FALSE, include=FALSE}

payments <- read_csv("../data/installments_payments.csv") 

cc_payments <- payments[payments$NUM_INSTALMENT_VERSION == 1, ] %>%
  select(-SK_ID_PREV) %>%
  mutate(PAYMENT_PERC = AMT_PAYMENT / AMT_INSTALMENT,
         PAYMENT_DIFF = AMT_INSTALMENT - AMT_PAYMENT,
         DPD = DAYS_ENTRY_PAYMENT - DAYS_INSTALMENT,
         DBD = DAYS_INSTALMENT - DAYS_ENTRY_PAYMENT,
         DPD = ifelse(DPD > 0, DPD, 0),
         DBD = ifelse(DBD > 0, DBD, 0)) %>%
  group_by(SK_ID_CURR) %>%
  summarise_all(fn)

var.names <- names(cc_payments)[!names(cc_payments) %in% "SK_ID_CURR"]

for (i in 2:length(var.names)) {
  nm = var.names[i]
  nm_mod = paste(nm, "_cc", sep="")
  var.names[i] <- nm_mod
}
var.names <- c("SK_ID_CURR", var.names)
names(cc_payments) <- var.names

totals <- payments %>%
  select(-SK_ID_PREV) %>%
  mutate(PAYMENT_PERC = AMT_PAYMENT / AMT_INSTALMENT,
         PAYMENT_DIFF = AMT_INSTALMENT - AMT_PAYMENT,
         DPD = DAYS_ENTRY_PAYMENT - DAYS_INSTALMENT,
         DBD = DAYS_INSTALMENT - DAYS_ENTRY_PAYMENT,
         DPD = ifelse(DPD > 0, DPD, 0),
         DBD = ifelse(DBD > 0, DBD, 0)) %>%
  group_by(SK_ID_CURR) %>%
  summarise_all(fn)

var.names <- names(totals)[!names(totals) %in% "SK_ID_CURR"]

for (i in 2:length(var.names)) {
  nm = var.names[i]
  nm_mod = paste(nm, "_total", sep="")
  var.names[i] <- nm_mod
}
var.names <- c("SK_ID_CURR", var.names)
names(totals) <- var.names

tr <- tr[, 1:121]

tr <- tr %>%
  left_join(cc_payments, by = "SK_ID_CURR") %>%
  left_join(totals, by = "SK_ID_CURR")
```


### Test new information from installment payments data:

```{r message=FALSE, warning=FALSE, include=FALSE}
y <- as.factor(tr$TARGET)
set.seed(1234)
down_tr <- caret::downSample(x = tr,y = y)
y_tr <- as.numeric(down_tr$Class)
y_tr[y_tr == 1] <- 0
y_tr[y_tr == 2] <- 1
down_tr$Class <- y_tr

IV <- create_infotables(data=down_tr, y="Class")
plot_infotables(IV, IV$Summary$Variable[1:20], same_scale=TRUE)

keep <- IV$Summary$Variable[(IV$Summary$IV >= 0.0001)]
tr <- tr[, keep]

rm(payments, totals, cc_payments); gc();

```



```{r message=FALSE, warning=FALSE, include=FALSE}
pc_balance <- read_csv("../data/POS_CASH_balance.csv")
# only pull the most recent month
pc_balance <- pc_balance[pc_balance$MONTHS_BALANCE == -1, ]

n_distinct(pc_balance$SK_ID_CURR)

pc_balance <- pc_balance %>% 
  select(-SK_ID_PREV) %>% 
  mutate_if(is.character, funs(factor(.) %>% as.integer)) %>% 
  group_by(SK_ID_CURR, NAME_CONTRACT_STATUS) %>% 
  summarise_all(fn)


sel <- names(pc_balance)[!names(pc_balance) %in% c("SK_ID_CURR", "NAME_CONTRACT_STATUS")]

pc_balance <- dcast(setDT(pc_balance), 
                   SK_ID_CURR ~ NAME_CONTRACT_STATUS, 
                   value.var = sel)


tr <- tr[, 1:121]
tr <- tr %>%
  left_join(pc_balance, by = "SK_ID_CURR") %>%

```



```{r message=FALSE, warning=FALSE, include=FALSE}
prev <- read_csv("../data/previous_application.csv")

sum_prev <- prev %>%
  select(-SK_ID_PREV) %>% 
  mutate_if(is.character, funs(factor(.) %>% as.integer)) %>% 
  mutate(DAYS_FIRST_DRAWING = ifelse(DAYS_FIRST_DRAWING == 365243, NA, DAYS_FIRST_DRAWING),
         DAYS_FIRST_DUE = ifelse(DAYS_FIRST_DUE == 365243, NA, DAYS_FIRST_DUE),
         DAYS_LAST_DUE_1ST_VERSION = ifelse(DAYS_LAST_DUE_1ST_VERSION == 365243, NA, DAYS_LAST_DUE_1ST_VERSION),
         DAYS_LAST_DUE = ifelse(DAYS_LAST_DUE == 365243, NA, DAYS_LAST_DUE),
         DAYS_TERMINATION = ifelse(DAYS_TERMINATION == 365243, NA, DAYS_TERMINATION),
         APP_CREDIT_PERC = AMT_APPLICATION / AMT_CREDIT) %>% 
  group_by(SK_ID_CURR) %>% 
  summarise_all(fn) 

rm(prev); gc()
```

```{r message=FALSE, warning=FALSE, include=FALSE}
tr <- read_csv("../data/application_train.csv")
te <- read_csv("../data/application_test.csv")

tr_te <- train %>% 
  select(-TARGET) %>% 
  bind_rows(test) %>%
  left_join(sum_bureau, by = "SK_ID_CURR") %>% 
  left_join(sum_cc_balance, by = "SK_ID_CURR") %>% 
  left_join(sum_payments, by = "SK_ID_CURR") %>% 
  left_join(sum_pc_balance, by = "SK_ID_CURR") %>% 
  left_join(sum_prev, by = "SK_ID_CURR") %>% 
  select(-SK_ID_CURR) %>% 
  mutate_if(is.character, funs(factor(.) %>% as.integer)) %>% 
  mutate(na = apply(., 1, function(x) sum(is.na(x))),
         DAYS_EMPLOYED = ifelse(DAYS_EMPLOYED == 365243, NA, DAYS_EMPLOYED),
         DAYS_EMPLOYED_PERC = sqrt(DAYS_EMPLOYED / DAYS_BIRTH),
         INCOME_CREDIT_PERC = AMT_INCOME_TOTAL / AMT_CREDIT,
         INCOME_PER_PERSON = log1p(AMT_INCOME_TOTAL / CNT_FAM_MEMBERS),
         ANNUITY_INCOME_PERC = sqrt(AMT_ANNUITY / (1 + AMT_INCOME_TOTAL)),
         #LOAN_INCOME_RATIO = AMT_CREDIT / AMT_INCOME_TOTAL,
         ANNUITY_LENGTH = AMT_CREDIT / AMT_ANNUITY,
         CHILDREN_RATIO = CNT_CHILDREN / CNT_FAM_MEMBERS, 
         CREDIT_TO_GOODS_RATIO = AMT_CREDIT / AMT_GOODS_PRICE,
         INC_PER_CHLD = AMT_INCOME_TOTAL / (1 + CNT_CHILDREN),
         SOURCES_PROD = EXT_SOURCE_1 * EXT_SOURCE_2 * EXT_SOURCE_3,
         CAR_TO_BIRTH_RATIO = OWN_CAR_AGE / DAYS_BIRTH,
         CAR_TO_EMPLOY_RATIO = OWN_CAR_AGE / DAYS_EMPLOYED,
         PHONE_TO_BIRTH_RATIO = DAYS_LAST_PHONE_CHANGE / DAYS_BIRTH,
         PHONE_TO_EMPLOY_RATIO = DAYS_LAST_PHONE_CHANGE / DAYS_EMPLOYED)


docs <- str_subset(names(tr), "FLAG_DOC")
live <- str_subset(names(tr), "(?!NFLAG_)(?!FLAG_DOC)(?!_FLAG_)FLAG_")
inc_by_org <- tr_te %>% 
  group_by(ORGANIZATION_TYPE) %>% 
  summarise(m = median(AMT_INCOME_TOTAL)) %$% 
  setNames(as.list(m), ORGANIZATION_TYPE)

tr_te %<>% 
  mutate(DOC_IND_KURT = apply(tr_te[, docs], 1, moments::kurtosis),
         LIVE_IND_SUM = apply(tr_te[, live], 1, sum),
         NEW_INC_BY_ORG = recode(tr_te$ORGANIZATION_TYPE, !!!inc_by_org),
         NEW_EXT_SOURCES_MEAN = apply(tr_te[, c("EXT_SOURCE_1", "EXT_SOURCE_2", "EXT_SOURCE_3")], 1, mean),
         NEW_SCORES_STD = apply(tr_te[, c("EXT_SOURCE_1", "EXT_SOURCE_2", "EXT_SOURCE_3")], 1, sd))%>%
  mutate_all(funs(ifelse(is.nan(.), NA, .))) %>% 
  mutate_all(funs(ifelse(is.infinite(.), NA, .)))

```


### Save results:

```{r message=FALSE, warning=FALSE, include=FALSE}

write.csv(sum_bureau, "../data/sum_bureau.csv")
write.csv(sum_cc_balance, "../data/sum_cc_balance.csv")
write.csv(sum_payments, "../data/sum_payments.csv")
write.csv(sum_pc_balance, "../data/sum_pc_balance.csv")
write.csv(sum_prev, "../data/sum_prev.csv")
write.csv(tr_te, "../data/train_test_combined.csv")
```


